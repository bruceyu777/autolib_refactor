<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Test Report</title>
        <style>
            :root {
                --primary-color: #4CAF50;
                --primary-hover: #45a049;
                --success-color: #10b981;
                --success-bg: #d1fae5;
                --success-border: #6ee7b7;
                --error-color: #ef4444;
                --error-bg: #fee2e2;
                --error-border: #fca5a5;
                --warning-color: #f59e0b;
                --warning-bg: #fef3c7;
                --neutral-color: #6b7280;
                --neutral-bg: #f3f4f6;
                --testing-color: #06b6d4;
                --testing-bg: #cffafe;
                --text-primary: #1f2937;
                --text-secondary: #6b7280;
                --border-color: #e5e7eb;
                --bg-primary: #ffffff;
                --bg-secondary: #f9fafb;
                --bg-tertiary: #f3f4f6;
                --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
                --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
                --radius-md: 0.5rem;
                --radius-lg: 0.75rem;
            }

            * {
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
                background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
                color: var(--text-primary);
                line-height: 1.6;
                margin: 0;
                padding: 0;
            }

            h2 {
                text-align: center;
                font-size: 24px;
                font-weight: 600;
                color: var(--text-primary);
                margin: 30px 0 20px;
                padding-bottom: 12px;
                border-bottom: 3px solid var(--primary-color);
                letter-spacing: -0.025em;
            }

            table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                margin: 16px 0;
                background: var(--bg-primary);
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: var(--shadow-md);
                font-size: 15px;
            }

            th, td {
                text-align: center;
                padding: 14px 16px;
                border-bottom: 1px solid var(--border-color);
            }

            th {
                background: linear-gradient(180deg, #f8f9fa 0%, var(--bg-tertiary) 100%);
                font-weight: 600;
                font-size: 0.8125rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--text-secondary);
                border-bottom: 2px solid var(--border-color);
            }

            tr:last-child td {
                border-bottom: none;
            }

            tbody tr {
                transition: background-color 0.15s ease;
            }

            tbody tr:hover {
                background-color: var(--bg-secondary);
            }

            a {
                text-decoration: none;
                color: var(--primary-color);
                font-weight: 500;
                transition: color 0.2s ease;
            }

            a:hover {
                color: var(--primary-hover);
                text-decoration: underline;
            }

            .summary-table td {
                text-align: center;
            }

            .success {
                background: linear-gradient(135deg, var(--success-bg) 0%, #a7f3d0 100%);
                color: #065f46;
                font-weight: 600;
                border-left: 4px solid var(--success-border);
            }

            .failure {
                background: linear-gradient(135deg, var(--error-bg) 0%, #fecaca 100%) !important;
                color: #991b1b;
                font-weight: 600;
                border-left: 4px solid var(--error-border);
            }

            .not-tested {
                background: linear-gradient(135deg, var(--neutral-bg) 0%, #e5e7eb 100%);
                color: #374151;
                font-weight: 600;
                border-left: 4px solid #9ca3af;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 24px;
            }

            .file-info, .test-summary {
                margin-bottom: 40px;
            }

            .status-testing {
                animation: pulse 1.5s infinite;
            }

            .status-testing td {
                color: #ffffff;
                background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%) !important;
                font-weight: 600;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                text-align: center;
            }

            .status-testing td:first-child {
                border-left: 4px solid #22d3ee;
            }

            .status-testing a {
                color: #ffffff;
                text-decoration: none;
            }

            .status-testing a:visited {
                color: #ffffff;
            }

            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.85;
                }
            }

            #failure_summary_table {
                width: 100%;
                table-layout: fixed;
                border-collapse: collapse;
            }

            #failure_summary_table > thead > tr > th,
            #failure_summary_table > tbody > tr > td {
                box-sizing: border-box;
                vertical-align: top;
                padding: 14px;
                word-wrap: break-word;
            }

            #failure_summary_table > thead > tr > th:nth-child(1),
            #failure_summary_table > tbody > tr > td:nth-child(1) {
                width: 10%;
                overflow: hidden;
                min-width: 0;
            }

            #failure_summary_table > thead > tr > th:nth-child(2),
            #failure_summary_table > tbody > tr > td:nth-child(2) {
                width: 90%;
                padding: 0;
            }

            .details-table {
                width: 98%;
                text-align: center;
                table-layout: fixed;
                border-collapse: collapse;
                margin: 8px auto;
                box-shadow: var(--shadow-sm);
            }

            .details-table th,
            .details-table td {
                box-sizing: border-box;
                vertical-align: top;
                padding: 10px;
                overflow: hidden;
                overflow-wrap: break-word;
                word-break: break-word;
                min-width: 0;
                white-space: normal;
            }

            .details-table th {
                background: linear-gradient(180deg, #fef2f2 0%, #fee2e2 100%);
                color: #991b1b;
                font-size: 0.75rem;
            }

            .details-table tr:nth-child(even) {
                background-color: #fef9f9;
            }

            .details-table tr th:nth-child(1),
            .details-table tr td:nth-child(1) {
                width: 8%;
            }

            .details-table tr th:nth-child(2),
            .details-table tr td:nth-child(2) {
                width: 40%;
            }

            .details-table tr td:nth-child(3) {
                width: 52%;
                text-align: left;
            }

            /* Stat Cards */
            .stat-card {
                display: inline-block;
                min-width: 80px;
                padding: 8px 16px;
                border-radius: var(--radius-md);
                font-weight: 600;
                text-align: center;
            }

            .stat-card.total {
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                color: #2e7d32;
            }

            .stat-card.passed {
                background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
                color: #065f46;
            }

            .stat-card.failed {
                background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
                color: #991b1b;
            }

            .stat-card.not-tested {
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                color: #374151;
            }

            /* Scrollbar Styling */
            ::-webkit-scrollbar {
                width: 10px;
                height: 10px;
            }

            ::-webkit-scrollbar-track {
                background: var(--bg-secondary);
            }

            ::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 5px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--text-secondary);
            }
        </style>
        <script>
            function saveScrollPosition() {
                const currentScroll = document.body.scrollTop || document.documentElement.scrollTop;
                sessionStorage.setItem('scrollPosition', currentScroll);
            }

            function restoreScrollPosition() {
                const scrollPosition = sessionStorage.getItem('scrollPosition');
                if (scrollPosition) {
                    document.body.scrollTop = parseInt(scrollPosition, 10);
                    document.documentElement.scrollTop = parseInt(scrollPosition, 10);
                }
            }

            function requireReload() {
                const rows = document.querySelectorAll("table#script_summary_table tbody tr");
                return Array.from(rows).some(row => {
                    const statusCell = row.cells[1];
                    return statusCell && statusCell.textContent.trim().toLowerCase().includes('testing');
                });
            }

            function autoReload() {
                setTimeout(() => {
                    location.reload();
                }, 30000);
            }

            function updateTestStatus() {
                const rows = document.querySelectorAll("table#script_summary_table tbody tr");
                rows.forEach(row => {
                    const statusCell = row.cells[1];
                    if (statusCell && statusCell.textContent.trim().toLowerCase() === 'testing') {
                        row.classList.add("status-testing");
                    }
                });
            }

            window.onload = function() {
                if (requireReload()) {
                    autoReload();
                    setTimeout(restoreScrollPosition, 50);
                    updateTestStatus();
                }
            };

            document.body.addEventListener('scroll', saveScrollPosition);
            document.documentElement.addEventListener('scroll', saveScrollPosition);
        </script>
    </head>
    <body>
        <div class="container">
            <!-- AutoTest Running Info -->
            <div class="file-info">
                <h2>üöÄ AutoTest Running Info</h2>
                <table id="run_info_table">
                    <thead>
                        <tr>
                            <th>Environment File</th>
                            <th>Test File</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><a href="/{{env_file}}" title="{{env_file}}">{{env_file.split('/')[-1]}}</a></td>
                            <td><a href="/{{test_file}}" title="{{test_file}}">{{test_file.split('/')[-1]}}</a></td>
                            <td>{{start_time}}</td>
                            <td>{{end_time}}</td>
                            <td>{{duration}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Testcases Result Summary -->
            <div class="test-summary">
                <h2>üìä Test Case Result Summary</h2>
                <table class="result_summary-table">
                    <thead>
                        <tr>
                            <th>Total Test Case</th>
                            <th>Passed</th>
                            <th>Failed</th>
                            <th>Not Tested</th>
                            <th>Passed Percentage (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="stat-card total">{{total_number}}</span></td>
                            <td><span class="stat-card passed">{{passed_number}}</span></td>
                            <td><span class="stat-card failed">{{failed_number}}</span></td>
                            <td><span class="stat-card not-tested">{{not_tested_number}}</span></td>
                            <td class="{{'success' if failed_number == 0 else 'failure'}}">{{passed_percentage}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Testcases Summary -->
            <div class="test-summary">
                <h2>üìù Test Case Summary</h2>
                <table id="testcase_summary_table">
                    <thead>
                        <tr>
                            <th>QAID</th>
                            <th>Result</th>
                            <th>Oriole Reported</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for testcase in testcase_results %}
                        <tr>
                            <td><a href="/{{qaid_script_mapping[testcase.id]}}">{{testcase.id}}</a></td>
                            <td class="{{'success' if testcase.res else 'failure'}}">
                                {{'PASSED' if testcase.res else 'FAILED'}}
                            </td>
                            <td class="{{'success' if testcase.reported else 'failure'}}">
                                {{'REPORTED' if testcase.reported else 'NOT REPORTED'}}
                            </td>
                        </tr>
                        {% endfor %}
                        {% for testcase in not_tested_cases %}
                        <tr>
                            <td>{{testcase}}</td>
                            <td class="not-tested">N/A</td>
                            <td class="not-tested">N/A</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Failed Testcases Details -->
            {% if failed_number != 0 %}
            <div class="test-summary">
                <h2>‚ùå Test Case Failure Details</h2>
                <table id="failure_summary_table">
                    <thead>
                        <tr>
                            <th>QAID</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for testcase in testcase_results %}
                        {% if not testcase.res %}
                        <tr>
                            <td><a href="/{{qaid_script_mapping[testcase.id]}}">{{testcase.id}}</a></td>
                            <td>
                                <table class="details-table">
                                    <thead>
                                        <tr>
                                            <th>Line #</th>
                                            <th>Expected</th>
                                            <th>Output</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for detail in testcase.details %}
                                        <tr>
                                            <td>{{detail.line_num}}</td>
                                            <td>{{detail.expect}}</td>
                                            <td>{{detail.output}}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

           <!-- Testscript Summary -->
            <div class="test-summary">
                <h2>üìú Test Script Summary</h2>
                <table id="script_summary_table">
                    <thead>
                        <tr>
                            <th>Test Script</th>
                            <th>Status</th>
                            <th>Elapsed Time (s)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for id, (status, duration) in testscripts.items() %}
                        <tr>
                            <td><a href="/{{qaid_script_mapping[id]}}">{{id}}</a></td>
                            <td>{{status}}</td>
                            <td>{{duration}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </body>
</html>
