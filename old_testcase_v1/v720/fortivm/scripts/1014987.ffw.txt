# 1014987ï¼šVerify ipv6 traffic pass/block base on  policy 
# 
# 
##################################################################

[FFW_A]
    ### 1014987.txt ###
    comment: 1014987:Verify ipv6 firewall policy work
    #setlicense -t FFW -for SN -to lic

    config system dns
        set primary 172.17.254.148
        set secondary 172.17.254.151
    end

    config system fortiguard
        set fortiguard-anycast disable
        set update-server-location automatic 
    end

    sleep 30
   
    forcelogin

    get system status | grep 'Serial-Number' -A 3
    expect -e "License Status: Valid" -for 1014987 -t 5

    config system interface
        edit "FFW_A:PORT2"
            config ipv6
                set ip6-mode static
                set ip6-address FFW_A:IPV6_PORT2/64
		set ip6-allowaccess ping ssh https telnet
            end
        next
        edit "FFW_A:PORT3"
            config ipv6
                set ip6-mode static
                set ip6-address FFW_A:IPV6_PORT3/64
		set ip6-allowaccess ping ssh https telnet
            end
        next
    end

    config firewall policy
        purge
        y
        edit 1014987
            set name "1014987"
            set srcintf "FFW_A:PORT2"
            set dstintf "FFW_A:PORT3"
            set srcaddr6 "all"
            set dstaddr6 "all"
            set action deny
            set schedule "always"
            set service ALL
            set logtraffic all
        next
    end

    show firewall policy

    config log memory setting
        set status enable
    end

    sleep 10
    diag sys session6 clear
    exe log delete-all
    y

#[PC_05]
    ip -6 addr add 2000:172:16:200::55/64 dev PC_05:ETH1 
    sleep 3

[PC_02]
    ip -6 addr add PC_02:IPV6_ETH1/64 dev PC_02:ETH1 
    #route -A inet6 add PC_05:IPV6_ETH1 gw FFW_A:IPV6_PORT2
    route -A inet6 add 2000:172:16:200::/64 gw FFW_A:IPV6_PORT2
    route -n -6
    sleep 5

    ping6 -c 5 PC_05:IPV6_ETH1
    #ping6 -c 5 FFW_A:IPV6_PORT3
    expect -e "64 bytes from" -fail match -for 1014987 -t 10


[FFW_A]
    sleep 10
    diagnose sys session6 clear

    exe log filter device memory 
    exe log filter category traffic
    exe log filter field subtype forward
    exe log filter field action deny
    exe log display
    expect -e "policyid=1014987" -for 1014987 -t 5

    config firewall policy
        edit 1014987
            set action accept
            set nat enable
            set logtraffic all
        next
    end

    show firewall policy

    diag sys session6 clear
    sleep 10 

[PC_02]

    ping6 -c 5 PC_05:IPV6_ETH1
    ping6 -c 5 FFW_A:IPV6_PORT3
    expect -e "64 bytes from" -for 1014987 -t 20

   # route -A inet6 del PC_05:IPV6_ETH1 gw FFW_A:IPV6_PORT2

[FFW_A]
    diag sys session6 clear
    sleep 2
    exe log filter device memory 
    exe log filter category traffic
    exe log filter field subtype forward
    exe log filter field action accept
    exe log filter field proto 58
    exe log display
    expect -e "policyid=1014987" -for 1014987 -t 5


    config firewall policy
    # purge
    #   y
    end

    report 1014987
   
