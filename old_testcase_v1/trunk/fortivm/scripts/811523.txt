# Attack Definition:
# regular db: /data/etc/ips.rules
# extended db" /data/etc/ips.et.rules
############## 811523 #######################

[FVM_A]
    comment 811523:Busy:Verify attack definition can be upgraded from cli via exec update-ips

    

     config ips global
	set database extended
     end

     config firewall policy
        edit 811523
            set name "811523"
            set srcintf "FVM_A:PORT2"
            set dstintf "FVM_A:PORT1"
            set srcaddr "all"
            set dstaddr "all"
            set action accept
            set schedule always
            set service "ALL"
            set inspection-mode flow 
            set utm-status enable
            set ips-sensor "all_default" 
            set profile-protocol-options "default"
            set ssl-ssh-profile "certificate-inspection"
            set nat enable
       next
    end

    # remove attack definition
    #<if FGT_A:Image eq deb>
    #    sysctl rm /data/etc/ips.et.rules -f 
    #FGT_A:Image eq out
    fnsysctl mv /data/etc/ips.et.rules /data/etc/ips.et.rules.tmp -f
    admin
    FVM_A:PASSWORD

    sleep 5
    diag autoupdate versions | grep 'Attack Extended Definitions' -A 6
    expect -e "Version: 0.00000" -for 811523 -t 10

    comment 811523:Busy:check upgrade from FDS  


    #exe update won't update if last update within 5 minutes
    #clear cache to make sure exe update-av work
    diag test application updated 4
    setvar -e "expiry-time=(\\d{1,2})" -to time
    #<if time eq 20>
        diag test application updated 4
    #    expect -e "expiry-time=0" -for 811521 -t 5
    #<fi>

    sleep 5
    exec update-ips

    sleep 150
    diag autoupdate version | grep 'Attack Extended Definitions' -A 6
    expect -e "Version: [1-9][0-9].[0-9]{5}" -for 811523 -t 5
    expect -e "Result: Updates Installed" -for 811523 -t 5

    report 811523
