# 1065379ï¼šFFW_VM64_KVM syntax can be collected 
# fortiguard settting default 
# FFVMBB license is available on FC-TST and FGD-Internal-Trunk
###############################################################


[FFW_A]
    ### 1065379.txt ###
    comment: Verify FFVMBB can be valided by FGD  

    setlicense -t FFW -for SN -to lic
    
    #remove license
    #execute factoryreset2    
    
    
    # validate license with internal FGD
    config system dns
    	set primary 172.17.254.148
    	set secondary 172.17.254.151
    end

    config system fortiguard
	set update-server-location automatic
        # command will fail if fgtvm is in ev license
        set fortiguard-anycast disable
    end

    sleep 10

    exe ping update.fortiguard.net
    sleep 20

    execute restore vmlicense tftp FFW_A:LICENSE_DIR{$lic} FFW_A:LICENSE_SERVER
	
   # sleep 10 
    # disable fortiguard-anycast before license validation
    config system fortiguard
        set update-server-location automatic
        set fortiguard-anycast disable
    end

    sleep 60
    forcelogin
    get system status | grep 'Serial-Number' -A 3
    expect -e "FFVMBB" -for 1065379 -t 5
    expect -e "License Status: Valid" -for 1065379 -t 5

    get system status | grep Branch
    setvar -e "Branch point: (.*)" -to BUILD

    print mgmt-data
    y
    y
    sleep 

[FFW_A]
    fortce_login
    sysctl sh
    cd /data
    ls -l mgmt-data*.xml
    varexpect -v {$BUILD} -for 1065379 -t 5

    tftp 10.6.30.139 mgmt-data-FortiFirewall-VM64-KVM-BB-740-B2357.xml put octet
    sleep 5
    exit

[PC_KVM]
    cd /tftpboot/
    rm mgmt*carrier.xml
    ls -l mgmt-data-FortiFirewall-VM64-KVM*.xml
    varexpect -v {$BUILD} -for 1065379 -t 5 
   
    report 1065379
