# Test case: 1038449
# Objective: Verify SN and FMG ip will be kept after exec factoryreset-for-central-management 
# Mantis: 0802001 7.0.6:B0351, 7.2.2:1312
#
##############################################################

[FVM_A]
    
    comment: 1038449 Verify factoryreset-for-central-management keep SN and FMG IP
    # get license file name
    setlicense -t 02G -for SN -to lic    
    
    execute restore vmlicense tftp FVM_A:LICENSE_DIR{$lic} FVM_A:LICENSE_SERVER
	
    get system status | grep 'Serial-Number' -A 3
    #expect -e "FGVM02T" -for 1038449 -t 5
    expect -e "License Status: Valid" -for 1038449 -t 5
    #expect -e "2 CPU/2 allowed" -for 1038449 -t 5
 
    config system global
        set admintimeout 479
    end

    # add fgfm to allowaccess
    config system interface
        edit FVM_A:PORT1
            set allowaccess ping https ssh snmp http telnet fgfm
        next
    end

    # config central management
    config system central-management
        set type fortimanager
        set fmg FVM_A:FMG_IP
          config server-list
              edit 1
                  set server-type update rating
                  set server-address FVM_A:FMG_IP
              next
          end
    end

    execute central-mgmt register-device FVM_A:FMG_SN FVM_A:FMG_PASS
    sleep 10 

    diag fdsm central-mgmt-status
    #expect -e "Registered" -for 1038449 -t 5

    execute factoryreset-for-central-management

    get system status | grep 'Serial-Number' -A 3
    expect -e "License Status: Invalid" -for 1038449 -t 5

    show full system global | grep admintimeout
    expect -e "admintimeout 5" -for 1038449 -t 5

    # Check fmg ip
    show full system central-management
    expect -e "FVM_A:FMG_IP" -for 1038449 -t 5

    # Check fmg SN
    get system central-management | grep serial-number
    expect -e "FVM_A:FMG_SN" -for 1038449 -t 5

    report 1038449

    config system interface
        edit FVM_A:PORT1
            set mode static
            set ip FVM_A:IPV4_PORT1 255.255.255.0
            set allowaccess ping https ssh http telnet
        next
    end

    config router static
        edit 1
            set gateway 10.6.30.254
            set device FVM_A:PORT1
        next
    end

    sleep 5   
    execute restore vmlicense tftp FVM_A:LICENSE_DIR{$lic} FVM_A:LICENSE_SERVER
    get system status | grep 'Serial-Number' -A 3
    #expect -e "FGVM02T" -for 1038449 -t 5
    expect -e "License Status: Valid" -for 1038449 -t 5

    # unregister fmg
    exe central-mgmt unregister-device FVM_A:FMG_SN

    
