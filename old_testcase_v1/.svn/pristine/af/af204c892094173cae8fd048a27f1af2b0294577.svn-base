# Test Case: 954436:Post-Paid flex vm FGVMML
# Test Case: 954445:cannot download with used token
# Test Case: 954441:verify correct cpu and license
# Used time: 
############################################################ 

[PC_KVM]
	comment 954436: Verify FGT_VM instance can manually activate license with token via CLI exec vm-license and SN prefix is FGVMML (M650936)
	comment 954441: Verify FGT_VM with FGVMML license get correct CPU capcity limitation and SLA from FDS
	comment 954445: Verify FGT_VM could not download license with a used token


     curl -H 'Content-Type: application/json' -X POST https://customerapiauth.fortinet.com/api/v1/oauth/token/ -d '{"username": "GLOBAL:FGVMML_API_id","password": "GLOBAL:FGVMML_API_psw","client_id": "flexvm", "grant_type": "password"}'    
    setvar -e "\"access_token\": \"(.*?)\"" -to fgvmml_access_token
    echo the fgvmml_access_token is {$fgvmml_access_token}


    curl -H 'Content-Type: application/json' -X POST https://support.fortinet.com/ES/api/flexvm/v1/vms/token -H 'Authorization: Bearer {$fgvmml_access_token}' -d '{"expireBefore": "2026-01-01T10:11:12-8:00","serialNumber": "GLOBAL:FGVMML_LIC_954436" }'
    setvar -e "\"token\":\"(.*?)\"" -to fgvmml_vmlic_token
    echo the fgvmml_vmlic_token is {$fgvmml_vmlic_token}

[FVM_B]

    #remove license
    execute factoryreset2
    y
    sleep 60

    forcelogin 
    get system status | grep 'Serial-Number' -A 3
    expect -e "FGVMEV" -for 954436 -t 10

    exe vm-license {$fgvmml_vmlic_token}
    y
    sleep 200 

    get system status | grep "Serial-Number" -A 5
    expect -e "FGVMML" -for 954436 -t 5
    expect -e "License Status: [Valid|Grace Period]" -for 954436 -t 5
    expect -e "Max number of virtual domains: 1" -for 954436 -t 10
    
    diag hardware sys vm full | grep "code"
    expect -e "200" -for 954436 -t 5

    diag deb vm-print-license
    expect -e "Model: ML" -for 954436 -t 5

    get system status | grep "Resources"
    expect -e "VM Resources: 1 CPU/2 allowed" -for 954441 -t 10

    diag deb vm-print-license 
    expect -e "VMLS:6:([0-9]{8}):([0-9]{8}):2" -for 954441 -t 10


    diag deb vm-print-license
    expect -e "Model: ML" -for 954441 -t 5 
    expect -e "CPU: 2(.*?)subscription:2" -for 954441 -t 10

    diag deb vm-print-license
    expect -e "AVDB:6:([0-9]{8}):([0-9]{8})" -for 954441 -t 10
    expect -e "NIDS:6:([0-9]{8}):([0-9]{8})" -for 954441 -t 10

     exec vm-license {$fgvmml_vmlic_token}
     y
     sleep 5
     expect -e "Forticare response error 58" -for 954445 -t 10
     expect -e "Failed to download VM license" -for 954445 -t 5
     sleep 10

     report 954436
     report 954441
     report 954445
