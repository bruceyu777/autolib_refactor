# Test Case: 811524
# Objective: Verify IPSEngine can be upgraded using exe update-ips
# 7.2.0 default ips engine flen-fos7.2-7.212.pkg
# EngineOld: flen-fos7.2-7.212.pkg 
############################################################

[FVM_A]
    comment 811524:Busy:Verify the IPSEngine can be upgrade from cli via exec update-ips

    diag autoupdate downgrade enable
    #comment 811524:Downgrade to previous IPSEngine first

    execute restore ips tftp FVM_A:EngineOld FVM_A:LICENSE_SERVER
    sleep 20

    diag autoupdate versions | grep 'IPS Attack' -A 6
    varexpect -v FVM_A:EngineOld -for 811524 -t 5

    comment 811524:Busy:check it can be upgraded to the newer version
    diag autoupdate downgrade disable

     config ips global
        set database extended
     end

     config firewall policy
        edit 811524
            set name "811524"
            set srcintf "FVM_A:PORT2"
            set dstintf "FVM_A:PORT1"
            set srcaddr "all"
            set dstaddr "all"
            set action accept
            set schedule always
            set service "ALL"
            set inspection-mode flow
            set utm-status enable
            set ips-sensor "all_default"
            set profile-protocol-options "default"
            set ssl-ssh-profile "certificate-inspection"
            set nat enable
       next
    end

    sysctl killall updated
    fnsysctl killall updated

    sleep 5
    exec update-ips
    sleep 120

    diag autoupdate version | grep 'IPS Attack Engine' -A 6
    expect -e "Result: Updates Installed" -for 811524 -t 10

    report 811524
