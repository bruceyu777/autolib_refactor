# 1015667ï¼šVerify sul-license can be valided
# fortiguard settting default (anycast=enable)
# 
#############################

[FVM_A]
    comments: Verify sul can be valided base on cpu cores with default FGD setting
    setlicense -t ULS -for SN -to lic

    #remove license
    execute factoryreset2    
    
    sleep 60

    get system status | grep 'Serial-Number' -A 3
    expect -e "Serial-Number: FGVMEV" -for 1015667 -t 5
    expect -e "License Status: Invalid" -for 1015667 -t 5
    
    execute restore vmlicense tftp FVM_A:LICENSE_DIR{$lic} FVM_A:LICENSE_SERVER
    sleep 60
	
    get system status | grep 'Serial-Number' -A 3
    expect -e "FGVMSL" -for 1015667 -t 5
    expect -e "License Status: Valid" -for 1015667 -t 5
    expect -e "4 CPU," -for 1015667 -t 5

    #s-license need to add cpu(see #596988)
    #exe cpu add cause kernel panic, comments it now
    #after B1315, switch to 4.19 kernel, hot-added vcpu is supported
    #exe cpu add 3
    #expect -e "Active CPU number: 4" -for 1015667 -t 5
    #expect -e "Total CPU number: 4" -for 1015667 -t 5

    diag debug vm-print-license
    expect -e "Model: SL" -for 1015667 -t 5
    expect -e "CPU: 2147483647" -for 1015667 -t 5

    # Test 1021271: FC-Only bundle(258)
    comment: Verify 1021271: check 258 FC-Only bundle contracts
    diagnose test update info | grep "System contracts" -A 1 
    setvar -e "ENHN,(.*)" -to CONTRACT

    diagnose test update info | grep FMWR
    varexpect -v {$CONTRACT} -for 1021271 -t 5

    diagnose test update info | grep VMLS
    varexpect -v {$CONTRACT} -for 1021271 -t 5

    diagnose test update info | grep FURL
    varexpect -v {$CONTRACT} -fail match -for 1021271 -t 5

    diagnose test update info | grep SPAM
    varexpect -v {$CONTRACT} -fail match -for 1021271 -t 5

    diagnose test update info | grep IOTH
    varexpect -v {$CONTRACT} -fail match -for 1021271 -t 5

    diagnose test update info | grep ETDB
    varexpect -v {$CONTRACT} -fail match -for 1021271 -t 5

    diagnose test update info | grep NIDB
    varexpect -v {$CONTRACT} -fail match -for 1021271 -t 5

    diagnose test update info | grep ISDB
    varexpect -v {$CONTRACT} -fail match -for 1021271 -t 5

    diagnose test update info | grep SFAS
    varexpect -v {$CONTRACT} -fail match -for 1021271 -t 5

    report 1015667
    report 1021271   
