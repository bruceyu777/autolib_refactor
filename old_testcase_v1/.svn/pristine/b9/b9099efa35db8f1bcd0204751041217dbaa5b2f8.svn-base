# 1006317ï¼šVerify g-license can be valided via FMG
# fortiguard settting default 
# 
#############################

[FVM_A]
    ### 1006317.txt ###
    comment: Verify G04 can be valided via FMG 

    # get license file name
    setlicense -t 04G -for SN -to lic
 
    #remove license
    execute factoryreset2    
    
    get system status | grep 'Serial-Number' -A 3
    expect -e "License Status: Invalid" -for 1006317 -t 5

    # add fgfm to allowaccess
    config system interface
        edit FVM_A:PORT1
            set allowaccess ping https ssh snmp http telnet fgfm
        next
    end

    #config static route only to FMG
    config router static
        edit 1
            set dst 172.18.64.0 255.255.255.0
            set gateway 10.6.30.254
            set device FVM_A:PORT1
        next
    end

    #config central management and update and rating using FMG
    config system central-management
        config server-list
     	    edit 1
		set server-type update rating
 		set server-address FVM_A:FMG_IP 
            next
	end
	set include-default-servers disable
    end


    execute restore vmlicense tftp FVM_A:LICENSE_DIR{$lic} FVM_A:LICENSE_SERVER

    sleep 10	
    get system status | grep 'Serial-Number' -A 3
    expect -e "FGVM04T" -for 1006317 -t 5
    expect -e "License Status: Valid" -for 1006317 -t 5
    expect -e "4 CPU/4 allowed" -for 1006317 -t 5

    # VM04: default 10 vdoms, max 10 vdoms
    diag debug vm-print-license
    expect -e "Model: 04" -for 1006317 -t 5
    expect -e "CPU: 4" -for 1006317 -t 5
    expect -e "permanent: 10" -for 1006317 -t 5

    # restore static route
    config router static
        edit 1
            unset dst 
            set gateway 10.6.30.254
            set device FVM_A:PORT1
        next
    end
    
    report 1006317

    config system central-management
        config server-list
            delete 1
        end
        unset include-default-servers 
    end
   
