#
# 6.4.0 default ips engine flen-fos6.4-6.016.pkg need to be placed in tftp server
############## 811524 #######################
[FVM_A]
    comment 811524:Busy:Verify the IPSEngine can be upgrade from cli via exec update-ips

    diag autoupdate downgrade enable
    #comment 811524:Downgrade to previous IPSEngine first

    execute restore ips tftp FVM_A:EngineOld FVM_A:LICENSE_SERVER
    y
    y
    sleep 20

    diag autoupdate versions | grep 'IPS Attack' -A 6

    comment 811524:Busy:check it can be upgraded to the newer version
    diag autoupdate downgrade disable


#exe update won't update if last update within 5 minutes
#clear cache to make sure exe update-ips work
diag test application updated 4
setvar -e "expiry-time=(\\d{1,2})" -to time
<if time eq 20>
    diag test application updated 4
    expect -e "expiry-time=0" -for 811521 -t 5
<fi>

    sleep 5
    exec update-ips
    sleep 120
    diag autoupdate version | grep 'IPS Attack Engine' -A 6
    expect -e "Result: Updates Installed" -for 811524 -t 10

    report 811524
