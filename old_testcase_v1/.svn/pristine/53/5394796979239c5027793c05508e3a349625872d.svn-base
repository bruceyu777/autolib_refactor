#installUpdObjRest[800]-Step 9:Delete backup /tmp/update.backup
#installUpdObjRest[824]-Step 10:Tell parent to respawn
#upd_install_pkg[1306]-AVEN028 is up-to-date
#upd_install_pkg[1306]-AVDB002 is up-to-date - avdb - vir
#upd_install_pkg[1306]-AVDB007 is up-to-date - etdb - virext
#upd_install_pkg[1332]-AVDB004 installed successfully - exdb  - virexdb
#upd_install_pkg[1306]-AVDB019 is up-to-date
#
# Test Case ID: 811521
# Objective: Verify AV definition can be updated manually by "execute update-av"
#################################################################

[FVM_A]
    comment 811521:Busy:Verify AV definition can be updated by exe update-av

    # database must be enabled and av profile must be assigned
    # in order for update to take effect
config antivirus profile 
   edit "av_test"
        set feature-set proxy 
        config http
            set av-scan block
        end
    next
end

config firewall policy
    edit 811521
        set name "811521"
        set srcintf "FVM_A:PORT2"
        set dstintf "FVM_A:PORT1"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule always
        set service "ALL"
        set inspection-mode proxy
        set utm-status enable
        set av-profile "av_test"
        set profile-protocol-options "default"
        set ssl-ssh-profile "certificate-inspection"
        set nat enable
    next
end
 

    fnsysctl mv /data2/vir /data2/vir.tmp -f
    admin
    FVM_A:PASSWORD
    fnsysctl mv /data2/virext /data2/virext.tmp -f
    admin
    FVM_A:PASSWORD
    # virexdb is extreme database
    #fnsysctl mv /data2/virexdb /data2/virexdb.tmp -f
    #admin
    #FVM_A:PASSWORD

    sleep 3
    diag autoupdate version | grep '^Virus Definitions' -A 6
    expect -e "Version: 0|1.00000" -for 811521 -t 10

    diag autoupdate version | grep 'Extended set' -A 6
    expect -e "Version: 0|1.00000" -for 811521 -t 10

    #exe update won't update if last update within 5 minutes
    #clear cache to make sure exe update-av work
    diag test app update 4 
    #diag test app update 4

    #fnsysctl killall updated

    diag debug app update 2
    diag debug enable

    exec update-av

   # expect -e "upd_install_pkg.*?AVDB.*?(?:is up-to-date|installed successfully)" -t 180 -for 811521

    sleep 180
    diag autoupdate version | grep '^Virus Definitions' -A 6
    expect -e "Version: 0.00000" -fail match -for 811521 -t 10
    expect -e "Result: Updates Installed" -for 811521 -t 10

    diag autoupdate version | grep 'Extended set' -A 6
    expect -e "Version: 0.00000" -fail match -for 811521 -t 10
    expect -e "Result: Updates Installed" -for 811521 -t 10


    diag debug application update 0
    diag debug reset

    #config firewall policy
    #    delete 811521
    #end

    report 811521
