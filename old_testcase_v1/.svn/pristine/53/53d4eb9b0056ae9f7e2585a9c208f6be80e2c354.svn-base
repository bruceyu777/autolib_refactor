# 959903ï¼šVerify traffic can go through policy and utm works with valid s-license 
# fortiguard settting default (anycast=enable)
# 2020-10-16
#############################

[PC_KVM]
    ### 959903.txt ###
    comments: Verify traffic can go through policy and utm works with valid s-license

    # get license file name
    cat PC_KVM:LICENSE_DIR/PC_KVM:LIECENSE_FILE | grep 04S
    setvar -e "(?n)^04S,(FGVMSL.*?lic)," -to lic

[FVM_A]
    config system fortiguard
        unset fortiguard-anycast
    end
    
    execute restore vmlicense tftp FVM_A:LICENSE_DIR{$lic} FVM_A:LICENSE_SERVER
    sleep 60
	
    get system status | grep 'Serial-Number' -A 3
    expect -e "FGVMSL" -for 959903 -t 5
    expect -e "License Status: Valid" -for 959903 -t 5

    config system interface
        edit "port2"
            set vdom "root"
            set ip 10.1.100.200 255.255.255.0
            set allowaccess ping https ssh http telnet
        next
        edit "port3"
            set vdom "root"
            set mode static
            set ip 172.16.200.200 255.255.255.0
            set allowaccess ping https ssh http telnet
        next
    end

    config firewall policy
        purge
        y
        edit 959903
            set name "959903"
            set srcintf "FVM_A:PORT2"
            set dstintf "FVM_A:PORT3"
            set srcaddr "all"
            set dstaddr "all"
            set action accept
            set schedule "always"
            set service "ALL"
            set utm-status enable
            set inspection-mode proxy
            set ssl-ssh-profile "certificate-inspection"
            set webfilter-profile "default"
            set av-profile "default"
            set nat enable
        next
    end

    sleep 10
    exe log delete-all
    y

[PC_01]
    route -n
    route del -net 172.16.200.0 netmask 255.255.255.0

    route add -net 172.16.200.0 netmask 255.255 gateway PC_05:FORTIVM01_PORT2_IPV4 dev eth1

    sleep 5
    rm -f eicar.*
    curl -v http://PC_05:PC_05/virus/eicar
    #curl http://wfurltest.fortiguard.com/wftest/11.html
    #expect -e "Web Page Blocked" -t 10 -for 959903
    #expect -e "Gambling" -t 5 -for 959903
    expect -e "not permitted" -t 30 -for 959903

  


    report 959903
   
