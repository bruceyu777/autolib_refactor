# 911060ï¼šVerify s-license with less cpu capacity can be loaded to vm with larger cpu counts 
# tested using s02-license on instance with 4 cpu 
# fortiguard settting default (anycast=enable)
# 
#############################

[PC_KVM]
    ### 911060.txt ###
    comment: Verify s02 can be valided base vm with 4 cpu
    #check vm cpu count
    virsh dominfo FVM_A 
    expect -e "CPU\(s\):         4" -for 911060 -t 5

    # get license file name
    #cat PC_KVM:LICENSE_DIR/PC_KVM:LIECENSE_FILE | grep 02S
    #setvar -e "(?n)^02S,(FGVMSL.*?lic)," -to lic
    setlicense -t 02S -for SN -to lic

[FVM_A]
    
    # fortiguard default setting
    config system fortiguard
        unset fortiguard-anycast
    end

#    show full sys fortiguard | grep anycast
#    expect -e "fortiguard-anycast enable" -for 911060 -t 5
    
    execute restore vmlicense tftp FVM_A:LICENSE_DIR{$lic} FVM_A:LICENSE_SERVER
    sleep 60 
	
    get system status | grep 'Serial-Number' -A 5
    expect -e "FGVMSL" -for 911060 -t 5
    expect -e "License Status: Valid" -for 911060 -t 5
    expect -e "1 CPU/2 allowed" -for 911060 -t 5

    #s-license need a reboot or exe cpu add to activate
    #exe cpu add cause kernel panic #0701739 
    #exe cpu add 1
    #expect -e "Active CPU number: 2" -for 911060 -t 10

    diag debug vm-print-license
    expect -e "Model: 18" -for 911060 -t 5
    expect -e "CPU: 2" -for 911060 -t 5

    report 911060
   
