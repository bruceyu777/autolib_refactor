# 850562ï¼šVerify offline license valid when near expiration
# license status show valid
# traffic can passthrough, utm is working
# traffic/utm log are working
# event log show license expire soon
#####################################################################

[FVM_B]
    ### 850561.txt ###
    comment: Verify offline license valid when near expiration

    # get license file name
    setlicense -t OFFLINE -for SN -to lic

    config system interface
        edit FVM_B:PORT1
            set vdom "root"
            set mode static
            set ip FVM_B:IPV4_PORT1 255.255.255.0
            set allowaccess ping https ssh http telnet
        next
        edit FVM_B:PORT2
            set vdom "root"
            set mode static
            set ip FVM_B:IPV4_PORT2 255.255.255.0
            set allowaccess ping https ssh http telnet
        next
        edit FVM_B:PORT3
            set vdom "root"
            set mode static
            set ip FVM_B:IPV4_PORT3 255.255.255.0
            set allowaccess ping https ssh http telnet
        next
    end

    config firewall policy
        purge
        y
        edit 850562
            set name "850562"
            set srcintf "FVM_B:PORT2"
            set dstintf "FVM_B:PORT3"
            set srcaddr "all"
            set dstaddr "all"
            set action accept
            set schedule "always"
            set service "ALL"
            set utm-status enable
            set av-profile "default"
            set profile-protocol-options "default"
            set ssl-ssh-profile "certificate-inspection"
            set nat enable
        next
    end
    
    # disable default route for closed network
    config router static
        edit 1
            set status disable
        next
    end

    sleep 10
    execute log delete-all
    yes

    # change system time to expired time
    exe date 2023-07-20
    sleep 30

    get system status | grep 'License'
    expect -e "License Status: Valid" -for 850562 -t 10


[PC_02]
    route -n
    route del -net 172.16.200.0 netmask 255.255.255.0
    route del -host 172.16.200.55

    route add -host 172.16.200.55 gw FVM_B:IPV4_PORT2
    sleep 3

    rm -f eicar.*
    curl -v http://PC_02:DESTINATION4/virus/eicar
    expect -e "not permitted" -t 30 -for 850562


	
[FVM_B]

    diag sys session filter dst 172.16.200.55
    diag sys session clear
    sleep 5

    #check event log
    execute log filter device disk
    execute log filter category event
    execute log filter field subtype system
    execute log filter field logdesc "VM license expiring"
    execute log display
    expect -e "License will expire in [1-9] day" -t 20 -for 850562

    #check traffic log
    exe log filter category traffic
    exe log filter field subtype forward
    exe log filter field policyid 850562
    exe log display
    expect -e "172.16.200.55" -for 850562 -t 10

    #check av log
    exe log filter category 2
    exe log display
    expect -e "172.16.200.55.*eicar" -for 850562 -t 5

    report 850562

    config router static
        edit 1
            set status enable
        next
    end

    # reset system time by reboot
    exe reboot
    y
  
 
